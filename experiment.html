<!doctype html>
<html>
  <head>
    <title>My experiment</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="jspsych-5.0.3/jspsych.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-survey-text.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-single-stim.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-survey-likert.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-call-function.js"></script>
    <link href="jspsych-5.0.3/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body>
  </body>
  <script>


  /* define welcome message block */
  // defining groups of questions that will go together.
  var subject_page = {
    type: 'survey-text',
    questions: ["What is your ID?"],
  };

  /* Define extraversion items */
  var Extra_Qs = [
    { questions: "Is outgoing, sociable.",
      data: {item: 'E1', type: 'BFI2', trait: 'extraversion', facet: 'Sociability'}},
    { questions: "Is talkative.",
      data: {item: 'E2', type: 'BFI2', trait: 'extraversion', facet: 'Sociability'}},
    { questions: "Tends to be quiet.",
      data: {item: 'E3', type: 'BFI2', trait: 'extraversion', facet: 'Sociability'}},
    { questions: "Is sometimes shy, introverted.",
      data: {item: 'E4', type: 'BFI2', trait: 'extraversion', facet: 'Sociability'}},
    { questions: "Has an assertive personality.",
      data: {item: 'E5', type: 'BFI2', trait: 'extraversion', facet: 'Assertiveness'}},
    { questions: "Is dominant, acts as a leader.",
      data: {item: 'E6', type: 'BFI2', trait: 'extraversion', facet: 'Assertiveness'}},
    { questions: "Finds it hard to influence people.",
      data: {item: 'E7', type: 'BFI2', trait: 'extraversion', facet: 'Assertiveness'}},
    { questions: "Prefers to have others take charge.",
      data: {item: 'E8', type: 'BFI2', trait: 'extraversion', facet: 'Assertiveness'}},
    { questions: "Is full of energy.",
      data: {item: 'E9', type: 'BFI2', trait: 'extraversion', facet: 'Energy Level'}},
    { questions: "Shows a lot of enthusiasm.",
      data: {item: 'E10', type: 'BFI2', trait: 'extraversion', facet: 'Energy Level'}},
    { questions: "Rarely feels excited or eager.",
      data: {item: 'E11', type: 'BFI2', trait: 'extraversion', facet: 'Energy Level'}},
    { questions: "Is less active than other people.",
      data: {item: 'E12', type: 'BFI2', trait: 'extraversion', facet: 'Energy Level'}}
  ];
  /* Define agreeableness items */
  var Agree_Qs = [
    { questions: "Is compassionate, has a soft heart.",
      data: {item: 'A1', type: 'BFI2', trait: 'agreeableness', facet: 'Compassion'}},
    { questions: "Is helpful and unselfish with others.",
      data: {item: 'A2', type: 'BFI2', trait: 'agreeableness', facet: 'Compassion'}},
    { questions: "Feels little sympathy for others.",
      data: {item: 'A3', type: 'BFI2', trait: 'agreeableness', facet: 'Compassion'}},
    { questions: "Can be cold and uncaring.",
      data: {item: 'A4', type: 'BFI2', trait: 'agreeableness', facet: 'Compassion'}},
    { questions: "Is respectful, treats others with respect.",
      data: {item: 'A5', type: 'BFI2', trait: 'agreeableness', facet: 'Respectfulness'}},
    { questions: "Is polite, courteous to others.",
      data: {item: 'A6', type: 'BFI2', trait: 'agreeableness', facet: 'Respectfulness'}},
    { questions: "Starts arguments with others.",
      data: {item: 'A7', type: 'BFI2', trait: 'agreeableness', facet: 'Respectfulness'}},
    { questions: "Is sometimes rude to others.",
      data: {item: 'A8', type: 'BFI2', trait: 'agreeableness', facet: 'Respectfulness'}},
    { questions: "Has a forgiving nature.",
      data: {item: 'A9', type: 'BFI2', trait: 'agreeableness', facet: 'Trust'}},
    { questions: "Assumes the best about people.",
      data: {item: 'A10', type: 'BFI2', trait: 'agreeableness', facet: 'Trust'}},
    { questions: "Tends to find fault with others.",
      data: {item: 'A11', type: 'BFI2', trait: 'agreeableness', facet: 'Trust'}},
    { questions: "Is suspicious of others' intentions.",
      data: {item: 'A12', type: 'BFI2', trait: 'agreeableness', facet: 'Trust'}}
  ];
  /* Define conscientiousness items */
  var Consc_Qs = [
    { questions: "Is systematic, likes to keep things in order.",
      data: {item: 'C1', type: 'BFI2', trait: 'conscientiousness', facet: 'Organization'}},
    { questions: "Keeps things neat and tidy.",
      data: {item: 'C2', type: 'BFI2', trait: 'conscientiousness', facet: 'Organization'}},
    { questions: "Tends to be disorganized.",
      data: {item: 'C3', type: 'BFI2', trait: 'conscientiousness', facet: 'Organization'}},
    { questions: "Leaves a mess, doesn't clean up.",
      data: {item: 'C4', type: 'BFI2', trait: 'conscientiousness', facet: 'Organization'}},
    { questions: "Is efficient, gets things done.",
      data: {item: 'C5', type: 'BFI2', trait: 'conscientiousness', facet: 'Productiveness'}},
    { questions: "Is persistent, works until the task is finished.",
      data: {item: 'C6', type: 'BFI2', trait: 'conscientiousness', facet: 'Productiveness'}},
    { questions: "Tends to be lazy.",
      data: {item: 'C7', type: 'BFI2', trait: 'conscientiousness', facet: 'Productiveness'}},
    { questions: "Has difficulty getting started on tasks.",
      data: {item: 'C8', type: 'BFI2', trait: 'conscientiousness', facet: 'Productiveness'}},
    { questions: "Is dependable, steady.",
      data: {item: 'C9', type: 'BFI2', trait: 'conscientiousness', facet: 'Responsibility'}},
    { questions: "Is reliable, can always be counted on.",
      data: {item: 'C10', type: 'BFI2', trait: 'conscientiousness', facet: 'Responsibility'}},
    { questions: "Can be somewhat careless.",
      data: {item: 'C11', type: 'BFI2', trait: 'conscientiousness', facet: 'Responsibility'}},
    { questions: "Sometimes behaves irresponsibly.",
      data: {item: 'C12', type: 'BFI2', trait: 'conscientiousness', facet: 'Responsibility'}}
  ];
  /* Define neuroticism items */
  var Neuro_Qs = [
    { questions: "Can be tense.",
      data: {item: 'N1', type: 'BFI2', trait: 'neuroticism', facet: 'Anxiety'}},
    { questions: "Worries a lot.",
      data: {item: 'N2', type: 'BFI2', trait: 'neuroticism', facet: 'Anxiety'}},
    { questions: "Is relaxed, handles stress well.",
      data: {item: 'N3', type: 'BFI2', trait: 'neuroticism', facet: 'Anxiety'}},
    { questions: "Rarely feels anxious or afraid.",
      data: {item: 'N4', type: 'BFI2', trait: 'neuroticism', facet: 'Anxiety'}},
    { questions: "Often feels sad.",
      data: {item: 'N5', type: 'BFI2', trait: 'neuroticism', facet: 'Depression'}},
    { questions: "Tends to feel depressed, blue.",
      data: {item: 'N6', type: 'BFI2', trait: 'neuroticism', facet: 'Depression'}},
    { questions: "Stays optimistic after experiencing a setback.",
      data: {item: 'N7', type: 'BFI2', trait: 'neuroticism', facet: 'Depression'}},
    { questions: "Feels secure, comfortable with self.",
      data: {item: 'N8', type: 'BFI2', trait: 'neuroticism', facet: 'Depression'}},
    { questions: "Is moody, has up and down mood swings.",
      data: {item: 'N9', type: 'BFI2', trait: 'neuroticism', facet: 'Emotional Volatility'}},
    { questions: "Is temperamental, gets emotional easily.",
      data: {item: 'N10', type: 'BFI2', trait: 'neuroticism', facet: 'Emotional Volatility'}},
    { questions: "Is emotionally stable, not easily upset.",
      data: {item: 'N11', type: 'BFI2', trait: 'neuroticism', facet: 'Emotional Volatility'}},
    { questions: "Keeps their emotions under control.",
      data: {item: 'N12', type: 'BFI2', trait: 'neuroticism', facet: 'Emotional Volatility'}}
  ];
  /* Define openness items */
  var Openn_Qs = [
    { questions: "Is curious about many different things.",
      data: {item: 'O1', type: 'BFI2', trait: 'openness', facet: 'Intellectual Curiosity'}},
    { questions: "Is complex, a deep thinker.",
      data: {item: 'O2', type: 'BFI2', trait: 'openness', facet: 'Intellectual Curiosity'}},
    { questions: "Avoids intellectual, philosophical discussions.",
      data: {item: 'O3', type: 'BFI2', trait: 'openness', facet: 'Intellectual Curiosity'}},
    { questions: "Has little interest in abstract ideas.",
      data: {item: 'O4', type: 'BFI2', trait: 'openness', facet: 'Intellectual Curiosity'}},
    { questions: "Is fascinated by art, music, or literature.",
      data: {item: 'O5', type: 'BFI2', trait: 'openness', facet: 'Aesthetic Sensitivity'}},
    { questions: "Values art and beauty.",
      data: {item: 'O6', type: 'BFI2', trait: 'openness', facet: 'Aesthetic Sensitivity'}},
    { questions: "Has few artistic interests.",
      data: {item: 'O7', type: 'BFI2', trait: 'openness', facet: 'Aesthetic Sensitivity'}},
    { questions: "Thinks poetry and plays are boring.",
      data: {item: 'O8', type: 'BFI2', trait: 'openness', facet: 'Aesthetic Sensitivity'}},
    { questions: "Is inventive, finds clever ways to do things.",
      data: {item: 'O9', type: 'BFI2', trait: 'openness', facet: 'Creative Imagination'}},
    { questions: "Is original, comes up with new ideas.",
      data: {item: 'O10', type: 'BFI2', trait: 'openness', facet: 'Creative Imagination'}},
    { questions: "Has little creativity.",
      data: {item: 'O11', type: 'BFI2', trait: 'openness', facet: 'Creative Imagination'}},
    { questions: "Has difficulty imagining things.",
      data: {item: 'O12', type: 'BFI2', trait: 'openness', facet: 'Creative Imagination'}}
  ];

  var sit_items = [
    { questions: "Deep thinking has to be done.",
      data: {item: 'D1', type: 'DIAMONDS', trait: 'NA', facet: 'Duty'}},
    { questions: "Deep thinking is required.",
      data: {item: 'D2', type: 'DIAMONDS', trait: 'NA', facet: 'Intellect'}},
    { questions: "Somebody is being threatened, accused, or criticized.",
      data: {item: 'D3', type: 'DIAMONDS', trait: 'NA', facet: 'Adversity'}},
    { questions: "Potential romantic partners are present.",
      data: {item: 'D4', type: 'DIAMONDS', trait: 'NA', facet: 'Mating'}},
    { questions:  "The situation is pleasant.",
      data: {item: 'D5', type: 'DIAMONDS', trait: 'NA', facet: 'pOsitivity'}},
    { questions: "The situation contains negative feelings (e.g., stress, anxiety, guilt, etc.).",
      data: {item: 'D6', type: 'DIAMONDS', trait: 'NA', facet: 'Negativity'}},
    { questions: "Somebody is being deceived.",
      data: {item: 'D7', type: 'DIAMONDS', trait: 'NA', facet: 'Deception'}},
    { questions: "Social interactions are possible or required.",
      data: {item: 'D8', type: 'DIAMONDS', trait: 'NA', facet: 'Sociability'}},
  ];

  var extra_items_sampled =
    jsPsych.randomization.sample(Extra_Qs, 3, false);
  var agree_items_sampled =
    jsPsych.randomization.sample(Agree_Qs, 3, false);
  var consc_items_sampled =
    jsPsych.randomization.sample(Consc_Qs, 3, false);
  var neuro_items_sampled =
    jsPsych.randomization.sample(Neuro_Qs, 3, false);
  var openn_items_sampled =
    jsPsych.randomization.sample(Openn_Qs, 3, false);

  // var pers_items_sampled = [
  //   jsPsych.randomization.sample(Extra_Qs, 3, false),
  //   jsPsych.randomization.sample(Agree_Qs, 3, false),
  //   jsPsych.randomization.sample(Consc_Qs, 3, false),
  //   jsPsych.randomization.sample(Neuro_Qs, 3, false),
  //   jsPsych.randomization.sample(Openn_Qs, 3, false),
  // ];

  // var sit = jsPsych.randomization.repeat(sit_items, 1)
  // var pers_sit_items_sampled = pers_items_sampled.concat(sit_items);
var pers_sit_items_sampled = extra_items_sampled.concat(agree_items_sampled,
consc_items_sampled, neuro_items_sampled, openn_items_sampled, sit_items);

  var E_beh_items = [
    { questions: "Went out to socialize.",
      data: {item: 'beh_E_1', trait: 'extraversion', type: 'behavior', facet: 'NA'}},
    { questions: "Took the lead in organizing a project or activity.",
      data: {item: 'beh_E_2', trait: 'extraversion', type: 'behavior', facet: 'NA'}},
    { questions: "Expressed my own opinion.",
      data: {item: 'beh_E_3', trait: 'extraversion', type: 'behavior', facet: 'NA'}},
    { questions: "Felt cheerful and happy.",
      data: {item: 'beh_E_4', trait: 'extraversion', type: 'behavior', facet: 'NA'}},
  ];

  var A_beh_items = [
    { questions: "Criticized someone.",
      data: {item: 'beh_A_1', trait: 'agreeableness', type: 'behavior', facet: 'NA'}},
    { questions: "Made a decision without consulting the others involved.",
      data: {item: 'beh_A_2', trait: 'agreeableness', type: 'behavior', facet: 'NA'}},
    { questions: "Accused someone of talking behind my back.",
      data: {item: 'beh_A_3', trait: 'agreeableness', type: 'behavior', facet: 'NA'}},
    { questions: "Had doubts about someone’s honesty.",
      data: {item: 'beh_A_4', trait: 'agreeableness', type: 'behavior', facet: 'NA'}},
  ];

  var C_beh_items = [
    { questions: "Checked out every detail on a task I completed.",
      data: {item: 'beh_C_1', trait: 'conscientiousness', type: 'behavior', facet: 'NA'}},
    { questions: "Did poorly on an assignment or exam.",
      data: {item: 'beh_C_2', trait: 'conscientiousness', type: 'behavior', facet: 'NA'}},
    { questions: "Finished a task on time.",
      data: {item: 'beh_C_3', trait: 'conscientiousness', type: 'behavior', facet: 'NA'}},
    { questions: "Forgot about an appointment.",
      data: {item: 'beh_C_4', trait: 'conscientiousness', type: 'behavior', facet: 'NA'}},
    { questions: "Skipped class, work, or other scheduled activities on a whim.",
      data: {item: 'beh_C_5', trait: 'conscientiousness', type: 'behavior', facet: 'NA'}},
    { questions: "Reflected on the consequences of an action before going ahead with something.",
      data: {item: 'beh_C_6', trait: 'conscientiousness', type: 'behavior', facet: 'NA'}},
  ];

  var N_beh_items = [
    { questions: "Felt anxious about work that needed to be done.",
      data: {item: 'beh_N_1', trait: 'neuroticism', type: 'behavior', facet: 'NA'}},
    { questions: "Experienced a lot of stress.",
      data: {item: 'beh_N_2', trait: 'neuroticism', type: 'behavior', facet: 'NA'}},
    { questions: "Felt sad.",
      data: {item: 'beh_N_3', trait: 'neuroticism', type: 'behavior', facet: 'NA'}},
    { questions: "Put myself down.",
      data: {item: 'beh_N_4', trait: 'neuroticism', type: 'behavior', facet: 'NA'}},
    { questions: "Complained about a problem I was having.",
      data: {item: 'beh_N_5', trait: 'neuroticism', type: 'behavior', facet: 'NA'}},
    { questions: "Gave in to a bad habit when I was nervous.",
      data: {item: 'beh_N_6', trait: 'neuroticism', type: 'behavior', facet: 'NA'}},
  ];

  var O_beh_items = [
    { questions: "Read a play or novel.",
      data: {item: 'beh_O_1', trait: 'openness', type: 'behavior', facet: 'NA'}},
    { questions: "Thought about my emotional reactions to something.",
      data: {item: 'beh_O_2', trait: 'openness', type: 'behavior', facet: 'NA'}},
    { questions: "Discussed politics.",
      data: {item: 'beh_O_3', trait: 'openness', type: 'behavior', facet: 'NA'}},
    { questions: "Tried out a new activity for the sake of doing something different.",
      data: {item: 'beh_O_4', trait: 'openness', type: 'behavior', facet: 'NA'}},
  ];

  var beh_items = E_beh_items.concat(A_beh_items, C_beh_items, N_beh_items, O_beh_items);

  var beh_items_shuffled = jsPsych.randomization.shuffle(beh_items);

  var pers_sit_items_sampled_shuffled = jsPsych.randomization.shuffle(pers_sit_items_sampled);

  questions_shuffled = [];
  item_shuffled = [];
  trait_shuffled = [];
  facet_shuffled = [];
  type_shuffled = [];

  for (var i = 0; i<pers_sit_items_sampled_shuffled.length; i++){
    questions_shuffled = questions_shuffled.concat(pers_sit_items_sampled_shuffled[i].questions)
    item_shuffled = item_shuffled.concat(pers_sit_items_sampled_shuffled[i].data.item)
    trait_shuffled = trait_shuffled.concat(pers_sit_items_sampled_shuffled[i].data.trait)
    facet_shuffled = facet_shuffled.concat(pers_sit_items_sampled_shuffled[i].data.facet)
    type_shuffled = type_shuffled.concat(pers_sit_items_sampled_shuffled[i].data.type)
  }

  beh_questions_shuffled = [];
  beh_item_shuffled = [];
  beh_trait_shuffled = [];
  beh_facet_shuffled = [];
  beh_type_shuffled = [];

  for (var i = 0; i<beh_items_shuffled.length; i++){
    beh_questions_shuffled = beh_questions_shuffled.concat(beh_items_shuffled[i].questions)
    beh_item_shuffled = item_shuffled.concat(beh_items_shuffled[i].data.item)
    beh_trait_shuffled = trait_shuffled.concat(beh_items_shuffled[i].data.trait)
    beh_facet_shuffled = facet_shuffled.concat(beh_items_shuffled[i].data.facet)
    beh_type_shuffled = type_shuffled.concat(beh_items_shuffled[i].data.type)
  }

  console.log(item_shuffled)

  /* define likert scale */
  var scale1 = ["Strongly Disagree", "Disagree", "Neutral", "Agree", "Strongly Agree"];

  var pers_sit_block = {
    type: 'survey-likert',
    labels: [scale1, scale1, scale1, scale1, scale1, scale1, scale1, scale1,
              scale1, scale1, scale1, scale1, scale1, scale1, scale1, scale1,
              scale1, scale1, scale1, scale1, scale1, scale1, scale1],
    preamble: "<p><strong>Please respond to each question relative to what you " +
        "were just doing.</strong></p>",
    questions: questions_shuffled,
    data: [item_shuffled, trait_shuffled, facet_shuffled, type_shuffled]
    //timeline: pers_sit_items_sampled_shuffled
  };

  var scale2 = ["Did Not Occur", "Occurred"];

  var beh_block = {
    type: 'survey-likert',
    labels: [scale2, scale2, scale2, scale2, scale2, scale2, scale2, scale2,
             scale2, scale2, scale2, scale2, scale2, scale2, scale2, scale2,
             scale2, scale2, scale2, scale2, scale2, scale2, scale2, scale2],
    preamble: "<p><strong>Please indicate which of the following occurred in " +
        "the last hour.</strong></p>",
    questions: beh_questions_shuffled,
    data: [beh_item_shuffled, beh_trait_shuffled, beh_facet_shuffled, beh_type_shuffled]
    // data: {your_variable_name: beh_items_shuffled}
  };

  // generate a random subject ID
  var SID_name = Math.floor(Math.random()*100000);

  // var start_time = jsPsych.startTime();
  var d = new Date();
  var start_month = d.getMonth() + 1;
  var start_day = d.getDate();
  var start_hour = d.getHours();
  var start_time = start_month+"-"+start_day+"_"+start_hour
  // var start_time = Date.now();
  console.log(start_time)
  console.log(SID_name)
  var save_data = {
    type: 'call-function',
    func: function(){saveData(SID_name+"_"+start_month+"-"+start_day+"_"+start_hour+".csv",
      jsPsych.data.dataAsCSV())}
}

// record the condition assignment in the jsPsych data
// this adds a property called 'subject' and a property called 'condition' to every trial
  jsPsych.data.addProperties({
    subject: SID_name
  });

  /* create experiment timeline array */
  var timeline = [];
  timeline.push(subject_page);
  timeline.push(pers_sit_block);
  timeline.push(beh_block);
  //timeline.push(save_data);

  /* start the experiment */
  // jsPsych.init({
  //   timeline: timeline
  // });

var csvString = jsPsych.data.dataAsCSV();
var file = SID_name+"_"+start_month+"-"+start_day+"_"+start_hour+".csv";

  function uploadFiles(file, name) {

  try {
    var dropbox = "ESM Data";
    var folder, folders = DriveApp.getFoldersByName(dropbox);

    if (folders.hasNext()) {
      folder = folders.next();
    } else {
      folder = DriveApp.createFolder(dropbox);
    }

    var file = folder.createFile(file);
    file.setName(name)
    file.setDescription("Uploaded by " + name);

  } catch (error) {

    return error.toString();

  }

}

  function saveData(filename, filedata){
  	$.ajax({
  		type:'post',
  		cache: false,
  		url: 'save_data.php', // this is the path to the above PHP script
  		data: {filename: filename, filedata: filedata}})
  }
  var currentTimeMS = Date.now();
  jsPsych.init({
  	// display_element: $('#jspsych-target'),
  	timeline: timeline,
    on_finish: function(){uploadFiles(csvString,file)}
  	//on_finish: function(){saveData(SID_name+"_"+start_month+"-"+start_day+"_"+start_hour+".csv",
    //  jsPsych.data.dataAsCSV())}
  });
</script>
</html>
